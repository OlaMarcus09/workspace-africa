import React, { useState, useEffect } from 'react';
import QRCode from "react-qr-code";

// Import all our page components from their own files
import HomePage from './HomePage.jsx';
import SearchResultsPage from './SearchResultsPage.jsx'; 
import ListSpacePage from './ListSpacePage.jsx';
import SpaceDetailPage from './SpaceDetailPage.jsx';

import { collection, getDocs, setDoc, doc, query, where, getDoc, addDoc, Timestamp } from "firebase/firestore";
import { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "firebase/auth";
import { db, auth } from './firebase.js';

// --- SHARED COMPONENTS (Restored) ---
const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-8 w-8 text-white"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const DollarSignIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-8 w-8 text-white"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
const BuildingIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-8 w-8 text-white"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="4"></line><line x1="15" y1="22" x2="15" y2="4"></line><line x1="2" y1="10" x2="22" y2="10"></line><line x1="2" y1="14" x2="22" y2="14"></line></svg>;

const AuthModal = ({ mode, onClose, setAuthMode }) => { 
    const [name, setName] = useState(''); 
    const [email, setEmail] = useState(''); 
    const [password, setPassword] = useState(''); 
    const [userType, setUserType] = useState('professional'); 
    const [error, setError] = useState(''); 
    const [loading, setLoading] = useState(false); 
    const isSignUp = mode === 'signup'; 
    const handleSignUp = async (e) => { e.preventDefault(); setLoading(true); setError(''); try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await setDoc(doc(db, "users", user.uid), { name: name, email: user.email, joinDate: Timestamp.now(), userType: userType }); onClose(); } catch (error) { setError(error.message); } setLoading(false); }; 
    const handleLogin = async (e) => { e.preventDefault(); setLoading(true); setError(''); try { await signInWithEmailAndPassword(auth, email, password); onClose(); } catch (error) { setError(error.message); } setLoading(false); }; 
    return ( <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md relative"><button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><XIcon /></button><h2 className="text-2xl font-bold text-center mb-6">{isSignUp ? 'Create Your Account' : 'Welcome Back'}</h2><form onSubmit={isSignUp ? handleSignUp : handleLogin}>{isSignUp && ( <> <div className="mb-4"><label className="block text-gray-700 font-semibold mb-2" htmlFor="name">Full Name</label><input type="text" id="name" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0052cc]" required /></div><div className="mb-4"><label className="block text-gray-700 font-semibold mb-2">I am a</label><select value={userType} onChange={(e) => setUserType(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0052cc]"><option value="professional">Professional (Looking for a space)</option><option value="partner">Partner (I own a space)</option></select></div></> )}<div className="mb-4"><label className="block text-gray-700 font-semibold mb-2" htmlFor="email">Email Address</label><input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0052cc]" required /></div><div className="mb-6"><label className="block text-gray-700 font-semibold mb-2" htmlFor="password">Password</label><input type="password" id="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0052cc]" required /></div>{error && <p className="text-red-500 text-sm mb-4">{error}</p>}<button type="submit" disabled={loading} className="w-full bg-[#0052cc] text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">{loading ? 'Processing...' : (isSignUp ? 'Sign Up' : 'Log In')}</button></form><p className="text-center text-sm text-gray-600 mt-6">{isSignUp ? 'Already have an account?' : "Don't have an account?"}<button onClick={() => setAuthMode(isSignUp ? 'login' : 'signup')} className="text-[#0052cc] font-semibold hover:underline ml-1">{isSignUp ? 'Log In' : 'Sign Up'}</button></p></div></div> ); 
};
const Header = ({ currentUser, onLoginClick, onSignUpClick, onLogout, setView }) => { 
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false); 
    return ( <header className="bg-white shadow-sm sticky top-0 z-40"><div className="container mx-auto px-6 py-4"><div className="flex justify-between items-center"><img src="https://res.cloudinary.com/dmqjicpcc/image/upload/v170286253/WorkSpaceAfrica_bgyjhe.png" alt="WorkSpace Africa Logo" className="h-8 w-auto cursor-pointer" onClick={() => setView('home')} /><nav className="hidden md:flex items-center space-x-8"><a href="#" onClick={(e) => {e.preventDefault(); setView('searchResults')}} className="text-gray-600 hover:text-[#0052cc]">Find a Space</a><a href="#" onClick={(e) => {e.preventDefault(); setView('list-space')}} className="text-gray-600 hover:text-[#0052cc]">List Your Space</a></nav><div className="hidden md:flex items-center space-x-4">{currentUser ? ( <> <button onClick={() => setView('dashboard')} className="font-semibold text-gray-600 hover:text-[#0052cc]">Dashboard</button> <button onClick={onLogout} className="bg-[#FFB400] text-white font-semibold py-2 px-5 rounded-lg hover:bg-opacity-90">Logout</button> </> ) : ( <> <button onClick={onLoginClick} className="font-semibold text-gray-600 hover:text-[#0052cc]">Login</button> <button onClick={onSignUpClick} className="bg-[#FFB400] text-white font-semibold py-2 px-5 rounded-lg hover:bg-opacity-90">Sign Up</button> </> )}</div><button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="md:hidden p-2" aria-label="Toggle menu">{mobileMenuOpen ? ( <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> ) : ( <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg> )} </button></div>{mobileMenuOpen && ( <div className="md:hidden mt-4 pb-4 border-t pt-4"><nav className="flex flex-col space-y-4"><a href="#" onClick={() => { setView('searchResults'); setMobileMenuOpen(false); }} className="text-gray-600 hover:text-[#0052cc] font-medium">Find a Space</a><a href="#" onClick={() => { setView('list-space'); setMobileMenuOpen(false); }} className="text-gray-600 hover:text-[#0052cc] font-medium">List Your Space</a><div className="border-t pt-4 space-y-3">{currentUser ? ( <> <button onClick={() => { setView('dashboard'); setMobileMenuOpen(false); }} className="w-full text-left font-semibold text-gray-600 hover:text-[#0052cc]">Dashboard</button> <button onClick={() => { onLogout(); setMobileMenuOpen(false); }} className="w-full bg-[#FFB400] text-white font-semibold py-2 px-5 rounded-lg">Logout</button> </> ) : ( <> <button onClick={() => { onLoginClick(); setMobileMenuOpen(false); }} className="w-full text-left font-semibold text-gray-600 hover:text-[#0052cc]">Login</button> <button onClick={() => { onSignUpClick(); setMobileMenuOpen(false); }} className="w-full bg-[#FFB400] text-white font-semibold py-2 px-5 rounded-lg">Sign Up</button> </> )}</div></nav></div> )}</div></header> ); 
};
const Footer = ({ setView }) => ( <footer className="bg-gray-800 text-white"><div className="container mx-auto px-6 py-12"><div className="grid md:grid-cols-4 gap-8"><div><h3 className="text-xl font-bold">WorkSpace Africa</h3><p className="mt-2 text-gray-400">The intelligent coworking marketplace.</p></div><div><h4 className="font-semibold">Company</h4><ul className="mt-4 space-y-2"><li><a href="#" onClick={() => setView('about')} className="text-gray-400 hover:text-white">About Us</a></li><li><a href="#" onClick={() => setView('contact')} className="text-gray-400 hover:text-white">Contact</a></li></ul></div><div><h4 className="font-semibold">Legal</h4><ul className="mt-4 space-y-2"><li><a href="#" onClick={() => setView('terms')} className="text-gray-400 hover:text-white">Terms of Service</a></li><li><a href="#" onClick={() => setView('privacy')} className="text-gray-400 hover:text-white">Privacy Policy</a></li></ul></div><div><h4 className="font-semibold">Connect</h4></div></div><div className="mt-12 border-t border-gray-700 pt-8 text-center text-gray-400"><p>&copy; 2025 WorkSpace Africa. All rights reserved.</p></div></div></footer> );
const SimplePage = ({ title, children }) => ( <div className="container mx-auto px-6 py-12"><h1 className="text-4xl font-bold text-gray-800 mb-8">{title}</h1><div className="bg-white rounded-lg shadow p-8 prose max-w-none">{children}</div></div> );

const DashboardPage = ({ currentUser, userProfile, refreshTrigger }) => { if (!userProfile) return <div className="text-center py-20">Loading profile...</div>; const ProfessionalDashboard = () => { const [myBookings, setMyBookings] = useState([]); const [isLoadingBookings, setIsLoadingBookings] = useState(true); useEffect(() => { const fetchBookings = async () => { if (!currentUser) return; setIsLoadingBookings(true); try { const q = query(collection(db, "bookings"), where("userId", "==", currentUser.uid)); const querySnapshot = await getDocs(q); const bookingsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setMyBookings(bookingsData); } catch (error) { console.error("Error fetching bookings:", error); } finally { setIsLoadingBookings(false); } }; fetchBookings(); }, [currentUser, refreshTrigger]); return ( <div className="container mx-auto px-6 py-12"><h1 className="text-4xl font-bold text-gray-800 mb-8">My Account</h1><div className="grid lg:grid-cols-3 gap-12"><div className="lg:col-span-1"><div className="bg-white rounded-lg shadow p-6"><h2 className="text-2xl font-bold text-gray-800 mb-6">Profile Details</h2><div className="space-y-4"><div><label className="block text-gray-700 font-semibold mb-2">Full Name</label><p className="text-gray-800 text-lg">{userProfile?.name || 'Not set'}</p></div><div><label className="block text-gray-700 font-semibold mb-2">Email</label><p className="text-gray-800">{userProfile?.email}</p></div><div><label className="block text-gray-700 font-semibold mb-2">Member Since</label><p className="text-gray-800">{userProfile?.joinDate?.toDate().toLocaleDateString() || 'N/A'}</p></div></div></div></div><div className="lg:col-span-2"><div className="bg-white rounded-lg shadow p-6"><h2 className="text-2xl font-bold text-gray-800 mb-6">My Bookings</h2>{isLoadingBookings ? ( <p>Loading your bookings...</p> ) : myBookings.length > 0 ? ( <ul className="space-y-4">{myBookings.map(booking => ( <li key={booking.id} className="flex justify-between items-center border-b pb-4"><div><p className="font-bold text-lg text-[#0052cc]">{booking.spaceName}</p><p className="text-sm text-gray-500">Date: {booking.date.toDate().toLocaleDateString()}</p></div><span className="text-sm font-semibold bg-green-100 text-green-700 px-3 py-1 rounded-full capitalize">{booking.status}</span></li> ))}</ul> ) : ( <p className="text-center text-gray-500 py-8">You haven't made any bookings yet.</p> )}</div></div></div></div> ); }; const PartnerDashboard = () => { const [mySpaces, setMySpaces] = useState([]); const [recentBookings, setRecentBookings] = useState([]); const [isLoading, setIsLoading] = useState(true); useEffect(() => { const fetchData = async () => { if (!currentUser) return; setIsLoading(true); try { const spacesQuery = query(collection(db, "spaces"), where("ownerId", "==", currentUser.uid)); const spacesSnapshot = await getDocs(spacesQuery); const spacesData = spacesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setMySpaces(spacesData); if (spacesData.length > 0) { const spaceIds = spacesData.map(space => space.id); const bookingsQuery = query(collection(db, "bookings"), where("spaceId", "in", spaceIds.slice(0,10))); const bookingsSnapshot = await getDocs(bookingsQuery); const bookingsData = bookingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setRecentBookings(bookingsData); } } catch (error) { console.error("Error fetching partner data:", error); } finally { setIsLoading(false); } }; fetchData(); }, [currentUser, refreshTrigger]); const totalRevenue = recentBookings.reduce((sum, b) => sum + (b.amountPaid || 0), 0); return ( <div className="container mx-auto px-6 py-12"><h1 className="text-4xl font-bold text-gray-800">Partner Dashboard</h1><p className="text-lg text-gray-500 mt-2">Manage your spaces and view your business performance.</p><div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8"><div className="bg-[#0052cc] rounded-lg shadow p-6 flex items-center"><div className="bg-blue-500 p-3 rounded-full mr-4"><UsersIcon /></div><div><p className="text-white text-3xl font-bold">{recentBookings.length}</p><p className="text-blue-200">Total Bookings</p></div></div><div className="bg-green-600 rounded-lg shadow p-6 flex items-center"><div className="bg-green-500 p-3 rounded-full mr-4"><DollarSignIcon /></div><div><p className="text-white text-3xl font-bold">₦{totalRevenue.toLocaleString()}</p><p className="text-green-200">Total Revenue</p></div></div><div className="bg-gray-700 rounded-lg shadow p-6 flex items-center"><div className="bg-gray-600 p-3 rounded-full mr-4"><BuildingIcon /></div><div><p className="text-white text-3xl font-bold">{mySpaces.length}</p><p className="text-gray-300">Listed Spaces</p></div></div></div><div className="mt-12"><h2 className="text-2xl font-bold text-gray-800 mb-6">Recent Bookings</h2><div className="bg-white rounded-lg shadow overflow-hidden">{isLoading ? <p className="p-6 text-center text-gray-500">Loading...</p> : recentBookings.length > 0 ? ( <div className="overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Space</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{recentBookings.map(b => ( <tr key={b.id}> <td className="px-6 py-4 whitespace-nowrap"><div className="text-sm font-medium text-gray-900">{b.spaceName}</div></td> <td className="px-6 py-4 whitespace-nowrap"><div className="text-sm text-gray-900">{b.userName}</div><div className="text-sm text-gray-500">{b.userEmail}</div></td> <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{b.date.toDate().toLocaleDateString()}</td> <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">₦{b.amountPaid.toLocaleString()}</td> </tr> ))}</tbody></table></div> ) : ( <p className="p-12 text-center text-gray-500">No bookings for your spaces yet.</p> )}</div></div></div> ); }; switch (userProfile.userType) { case 'professional': return <ProfessionalDashboard />; case 'partner': return <PartnerDashboard />; default: return <p className="text-center py-20">Unknown user type.</p>; } };
const BookingConfirmationPage = ({ booking, setView }) => { if (!booking) { return ( <div className="text-center py-20"><p className="text-xl">No booking details found.</p><button onClick={() => setView('home')} className="mt-4 bg-[#0052cc] text-white font-bold py-3 px-6 rounded-lg">Back to Home</button></div> ); } const qrCodeValue = `BookingID: ${booking.id}, Space: ${booking.spaceName}, Date: ${booking.date.toDate().toLocaleDateString()}, User: ${booking.userName}`; return ( <div className="bg-gray-50 py-12"><div className="container mx-auto px-6 max-w-2xl text-center"><div className="bg-white rounded-lg shadow-xl p-8"><h1 className="text-3xl font-bold text-green-600">✅ Booking Confirmed!</h1><p className="text-gray-600 mt-2">You're all set! Present this QR code at check-in.</p><div className="my-8 bg-white p-6 inline-block rounded-lg border"><QRCode value={qrCodeValue} size={200} /></div><div className="text-left bg-gray-50 rounded-lg p-6 border"><h2 className="font-bold text-lg mb-4">Booking Details</h2><div className="space-y-3"><div className="flex justify-between"><span className="font-semibold text-gray-600">Space:</span><span className="font-medium text-gray-800">{booking.spaceName}</span></div><div className="flex justify-between"><span className="font-semibold text-gray-600">Location:</span><span className="font-medium text-gray-800">{booking.spaceLocation}</span></div><div className="flex justify-between"><span className="font-semibold text-gray-600">Date:</span><span className="font-medium text-gray-800">{booking.date.toDate().toLocaleDateString()}</span></div><div className="flex justify-between"><span className="font-semibold text-gray-600">Amount Paid:</span><span className="font-medium text-gray-800">₦{booking.amountPaid.toLocaleString()}</span></div><div className="flex justify-between"><span className="font-semibold text-gray-600">Booking Ref:</span><span className="font-medium text-gray-800">{booking.transactionRef}</span></div></div></div><div className="mt-8 flex flex-col sm:flex-row justify-center gap-4"><button onClick={() => setView('dashboard')} className="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300">View My Bookings</button><button onClick={() => setView('home')} className="bg-[#0052cc] text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">Book Another Space</button></div></div></div></div> ); };


// --- MAIN APP COMPONENT ---
export default function App() {
  const [spaces, setSpaces] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [view, setView] = useState('home');
  const [selectedSpace, setSelectedSpace] = useState(null);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [currentUser, setCurrentUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [refreshTrigger, setRefreshTrigger] = useState(0);
  const [latestBooking, setLatestBooking] = useState(null);
  const [previousView, setPreviousView] = useState('home');

  useEffect(() => { const unsubscribe = onAuthStateChanged(auth, async (user) => { setCurrentUser(user); if (user) { const userDocRef = doc(db, "users", user.uid); const userDocSnap = await getDoc(userDocRef); if (userDocSnap.exists()) { setUserProfile(userDocSnap.data()); } else { setUserProfile(null); } } else { setUserProfile(null); } }); return () => unsubscribe(); }, []);
  useEffect(() => { const fetchSpaces = async () => { setIsLoading(true); try { const querySnapshot = await getDocs(collection(db, "spaces")); const spacesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setSpaces(spacesData); } catch (error) { console.error("Error fetching spaces:", error); } finally { setIsLoading(false); } }; fetchSpaces(); }, [refreshTrigger]);

  const handleSelectSpace = (space) => { setPreviousView(view); setSelectedSpace(space); setView('spaceDetail'); };
  const openModal = (mode) => { setAuthMode(mode); setShowAuthModal(true); };
  const handleLogout = async () => { await signOut(auth); setView('home'); };
  const handleBookingComplete = (newBookingData) => { setLatestBooking(newBookingData); setRefreshTrigger(prev => prev + 1); setView('bookingConfirmation'); };
  const handleSearch = () => { setView('searchResults'); };
  
  const renderView = () => {
    switch (view) {
      case 'list-space': return <ListSpacePage setView={setView} currentUser={currentUser} />;
      case 'searchResults': return <SearchResultsPage spaces={spaces} isLoading={isLoading} onSelectSpace={handleSelectSpace} onBack={() => setView('home')} />;
      case 'dashboard': return <DashboardPage currentUser={currentUser} userProfile={userProfile} refreshTrigger={refreshTrigger} />;
      case 'spaceDetail': return <SpaceDetailPage space={selectedSpace} onBack={() => setView(previousView)} currentUser={currentUser} userProfile={userProfile} openLoginModal={() => openModal('login')} onBookingComplete={handleBookingComplete} />;
      case 'bookingConfirmation': return <BookingConfirmationPage booking={latestBooking} setView={setView} />;
      case 'terms': return <SimplePage title="Terms of Service"><p>Your terms...</p></SimplePage>;
      case 'privacy': return <SimplePage title="Privacy Policy"><p>Your privacy policy...</p></SimplePage>;
      case 'about': return <SimplePage title="About Us"><p>About WorkSpace Africa...</p></SimplePage>;
      case 'contact': return <SimplePage title="Contact Us"><p>Contact info...</p></SimplePage>;
      case 'home': 
      default: 
        return <HomePage spaces={spaces} onSelect={handleSelectSpace} isLoading={isLoading} onSearch={handleSearch} />;
    }
  };

  return (
    <div className="bg-gray-50 font-sans">
      <Header currentUser={currentUser} onLoginClick={() => openModal('login')} onSignUpClick={() => openModal('signup')} onLogout={handleLogout} setView={setView} />
      {showAuthModal && <AuthModal mode={authMode} onClose={() => setShowAuthModal(false)} setAuthMode={setAuthMode} />}
      <main>{renderView()}</main>
      <Footer setView={setView} />
    </div>
  );
}